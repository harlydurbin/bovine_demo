---
title: "Plink QC/dataset creation"
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(readr)
library(magrittr)
library(purrr)
library(dplyr)
library(stringr)
```

# Setup

```{r}
sample_metadata <- 
  read_csv(here::here("data/derived_data/metadata/bovine_demo.sample_metadata.csv")) %>% 
  mutate(international_id = if_else(international_id == "CPC98_Bprimigenius_EnglandDerbyshire_5936", "ancient_derbyshire", international_id))
```

# Dataset key

* Which samples

```{r}
tibble::tribble(
  ~ Name, ~ Description, ~ `k ran`,
  "full", "All species. All available samples.", "1-20",
  "20all", "All species. Up to 20 (ranked by coverage) samples per population label.", "1-20",
  "5regionall", "All species. Up to 5 (ranked by coverage) samples per species per region", "1-20",
  "20cattle", "Bos taurus, B.indicus, B. primigenius, composite. Up to 20 (ranked by coverage) samples per population label.", "1-20",
  "5cattle", "Bos taurus, B.indicus, B. primigenius, composite. Up to 5 (ranked by coverage) samples per population label.", "1-20",
  "5taurine", "Bos taurus, B. primigenius. Up to 5 (ranked by coverage) samples per population label.", "1-20",
  "allyak", "B. grunniens and B. mutus. All available samples.", "1-10",
  "allgayalgaur", "B. frontalis and B. gaurus. All available samples.", "1-10",
  "allbanteng", "B. javanicus. All available samples.", "1-8"
)
```

* Thinning parameter

```{r}
tibble::tribble(
  ~ Name, ~ Description,
  "superthin", "Randomly retain 0.001% of SNPs from each chromosome",
  "onepercent", "Randomly retain 0.01% of SNPs from each chromosome"
)
```

# Dataset creation

```{r}
sample_metadata %>% 
  group_by(species) %>% 
  tally(sort = TRUE)
```

## `20all`

```{r}
sample_metadata %>% 
  group_by(population) %>% 
  top_n(20, avg_coverage) %>% 
  ungroup() %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.20all.txt"), col_names = FALSE)
```

## `5regionall`

```{r}
sample_metadata %>% 
  mutate(
    region = 
      case_when(
        region == "france" ~ "continental europe",
        region == "australia" ~ "americas",
        TRUE ~ region
      )
  ) %>% 
  group_by(region, species) %>% 
  top_n(5, avg_coverage) %>% 
  ungroup() %>%
  arrange(region, species, population) %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.5regionall.txt"), col_names = FALSE)
```

## `20cattle`

```{r}
sample_metadata %>% 
  filter(species %in% c("bos primigenius", "bos taurus", "composite", "bos indicus")) %>% 
  group_by(population) %>% 
  top_n(20, avg_coverage) %>% 
  ungroup() %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.20cattle.txt"), col_names = FALSE)
```

## `5cattle`

```{r}
sample_metadata %>% 
  filter(species %in% c("bos primigenius", "bos taurus", "composite", "bos indicus")) %>% 
  group_by(population) %>% 
  top_n(5, avg_coverage) %>% 
  ungroup() %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.5cattle.txt"), col_names = FALSE)
```

## `5taurine`

```{r}
sample_metadata %>% 
  filter(species %in% c("bos primigenius", "bos taurus")) %>% 
  group_by(population) %>% 
  top_n(5, avg_coverage) %>% 
  ungroup() %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.5taurine.txt"), col_names = FALSE)
```

## `allyak`

```{r}
sample_metadata %>% 
  filter(species %in% c("bos grunniens", "bos mutus")) %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.allyak.txt"), col_names = FALSE)

```

## `allgaurgayal`

```{r}
sample_metadata %>% 
  filter(species %in% c("bos gaurus", "bos frontalis")) %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.allgaurgayal.txt"), col_names = FALSE)
```

## `allbanteng`

```{r}
sample_metadata %>% 
  filter(species %in% c("bos javanicus")) %>% 
  mutate(fid = international_id) %>% 
  select(international_id, fid) %>% 
  write_tsv(here::here("data/derived_data/plink_qc/thin_variants/keeplist.allbanteng.txt"), col_names = FALSE)
```

